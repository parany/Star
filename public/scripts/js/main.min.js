starApp=angular.module("starApp",["ngRoute","ngTable","ngCookies","textAngular","chart.js","ui.bootstrap"]),starApp.config(function(e,t){e.debugInfoEnabled(t.debug)}),starApp.config(function(e,t){e.when("/login",{templateUrl:"views/pages/account/login.html",controller:"loginController",access_level:t.Pub,menuId:"read"}).when("/",{templateUrl:"views/pages/read/index.html",controller:"readController",access_level:t.Pub,menuId:"read"}).when("/notes",{templateUrl:"views/pages/note/list.html",controller:"listNoteController",access_level:t.Pub,menuId:"read"}).when("/note/add/:id",{templateUrl:"views/pages/note/add.html",controller:"addNoteController",access_level:t.Pub,menuId:"read"}).when("/note/edit/:id",{templateUrl:"views/pages/note/edit.html",controller:"editNoteController",access_level:t.Pub,menuId:"read"}).when("/agendas",{templateUrl:"views/pages/agenda/index.html",controller:"agendaController",access_level:t.Pub,menuId:"agenda"}).when("/agendas/detail/:id",{templateUrl:"views/pages/agenda/detail.html",controller:"detailAgendaController",access_level:t.Pub,menuId:"agenda"}).when("/agendas/add",{templateUrl:"views/pages/agenda/add.html",controller:"addAgendaController",access_level:t.Pub,menuId:"agenda"}).when("/agendas/edit/:id",{templateUrl:"views/pages/agenda/edit.html",controller:"editAgendaController",access_level:t.Pub,menuId:"agenda"}).when("/dicos",{templateUrl:"views/pages/dico/index.html",controller:"dicosController",access_level:t.Pub,menuId:"dico"}).when("/dicos/add",{templateUrl:"views/pages/dico/add.html",controller:"addDicoController",access_level:t.Pub,menuId:"dico"}).when("/dicos/edit/:id",{templateUrl:"views/pages/dico/add.html",controller:"addDicoController",access_level:t.Pub,menuId:"dico"}).when("/treaties",{templateUrl:"views/pages/treaty/index.html",controller:"treatyController",access_level:t.Pub,menuId:"treaty"}).when("/treaties/detail/:id",{templateUrl:"views/pages/treaty/detail.html",controller:"detailTreatyController",access_level:t.Pub,menuId:"treaty"}).when("/treaties/add",{templateUrl:"views/pages/treaty/add.html",controller:"addTreatyController",access_level:t.Pub,menuId:"treaty"}).when("/treaties/edit/:id",{templateUrl:"views/pages/treaty/add.html",controller:"addTreatyController",access_level:t.Pub,menuId:"treaty"}).when("/explications",{templateUrl:"views/pages/explication/index.html",controller:"explicationController",access_level:t.Pub,menuId:"explication"}).when("/explications/add",{templateUrl:"views/pages/explication/Add.html",controller:"addExplicationController",access_level:t.Pub,menuId:"explication"}).when("/explications/edit/:id",{templateUrl:"views/pages/explication/add.html",controller:"addExplicationController",access_level:t.Pub,menuId:"explication"}).when("/explications/detail/:id",{templateUrl:"views/pages/explication/detail.html",controller:"detailExplicationController",access_level:t.Pub,menuId:"explication"}).when("/news",{templateUrl:"views/pages/new/index.html",controller:"newController",access_level:t.Pub,menuId:"new"}).when("/news/detail/:id",{templateUrl:"views/pages/new/detail.html",controller:"detailNewController",access_level:t.Pub,menuId:"new"}).when("/news/add",{templateUrl:"views/pages/new/add.html",controller:"addNewController",access_level:t.Pub,menuId:"new"}).when("/news/edit/:id",{templateUrl:"views/pages/new/add.html",controller:"addNewController",access_level:t.Pub,menuId:"new"}).when("/activities",{templateUrl:"views/pages/activity/index.html",controller:"activityController",access_level:t.Pub,menuId:"account"}).when("/tweets",{templateUrl:"views/pages/tweet/index.html",controller:"tweetController",access_level:t.Pub,menuId:"tweet"}).when("/tweets/add",{templateUrl:"views/pages/tweet/add.html",controller:"addTweetController",access_level:t.Pub,menuId:"tweet"}).when("/tweets/edit/:id",{templateUrl:"views/pages/tweet/add.html",controller:"addTweetController",access_level:t.Pub,menuId:"tweet"}).when("/chat",{templateUrl:"views/pages/chat/index.html",controller:"chatController",access_level:t.Pub}).when("/error500",{templateUrl:"views/pages/error/500.html",controller:"error500Controller",access_level:t.Pub,menuId:"error"})}),starApp.constant("ACCESS_LEVELS",{Pub:0,Admin:1}),starApp.run(function(e){e.$on("$routeChangeStart",function(e,t){angular.element("li").removeClass("active"),void 0!==t&&angular.element("#"+t.menuId).addClass("active")})}),starApp.factory("htppInterceptor500",function(e,t){var a={responseError:function(a){return 403===a.status?t.path("/login"):401!==a.status&&t.path("/error500"),e.reject(a)}};return a}),starApp.config(function(e){e.interceptors.push("htppInterceptor500")}),starApp.factory("tokenInterceptor",function(e,t){return{request:function(e){return e.headers=e.headers||{},localStorage.token&&(e.headers.Authorization=localStorage.token),e},requestError:function(t){return e.reject(t)},response:function(t){return t||e.when(t)},responseError:function(a){return null!==a&&401===a.status&&localStorage.token&&(localStorage.removeItem("token"),t.path("/login")),e.reject(a)}}}),starApp.config(function(e){e.interceptors.push("tokenInterceptor")}),starApp.constant("STAR_CONFIG",{debug:!0}),Date.prototype.toAnyString=function(){return this.getFullYear()+"-"+parseInt(this.getMonth()+1).format()+"-"+this.getDate().format()},Date.prototype.toCompareString=function(){return this.getDate().format()+"/"+parseInt(this.getMonth()+1).format()+"/"+this.getFullYear()},Date.prototype.getFirstMsOfDay=function(){return this.setHours(0,0,0,0)},Date.prototype.getLastMsOfDay=function(){return this.setHours(23,59,59,999)},Date.prototype.getFirstMsOfYear=function(){var e=this.setMonth(0,1);return new Date(e).getFirstMsOfDay()},Date.prototype.getLastMsOfYear=function(){var e=this.setMonth(11,31);return new Date(e).getLastMsOfDay()},Date.prototype.getFirstMsOfMonth=function(){var e=this.setDate(1);return new Date(e).getFirstMsOfDay()},Date.prototype.getLastMsOfMonth=function(){var e=this.setDate(31);return new Date(e).getLastMsOfDay()},Date.prototype.getFirstMsOfWeek=function(){var e=this.getDay(),t=864e5*e,a=this.getFirstMsOfDay();return a-t},Date.prototype.getLastMsOfWeek=function(){var e=this.getDay(),t=864e5*(6-e+1),a=this.getFirstMsOfDay();return a+t},Date.prototype.getElapsed=function(){var e=new Date(new Date-this),t="";return e.getMonth()&&(t+=`${e.getMonth()+1}M `),e.getDate()-1&&(t+=`${e.getDate()-1}d `),e.getHours()-3&&(t+=`${e.getHours()-3}h `),e.getMinutes()&&(t+=`${e.getMinutes()}min `),t+=`${e.getSeconds()}sec `},Number.prototype.format=function(){return(this+"").length<2?"0"+this:this},starApp.factory("starTable",function(e,t){function a(a,n,r,i){var o=n.split("."),s={page:1,count:i?i:10},l={counts:[],getData:function(e,t){2===o.length?e.resolve(a[o[0]][o[1]].slice((t.page()-1)*t.count(),t.page()*t.count())):e.resolve(a[o[0]].slice((t.page()-1)*t.count(),t.page()*t.count()))},$scope:{$data:{}}};r&&(s.sorting={Date:"desc"},l.groupBy="DateGroup",l.total=a.datas.length);var c=new t(s,l);return r&&(c.settings.getData=function(t,n){var r=n.sorting()?e("orderBy")(a.datas,c.orderBy()):a.datas.length;t.resolve(r.slice((n.page()-1)*n.count(),n.page()*n.count()))}),c}return{create:a}}),starApp.factory("genericService",function(e,t){function a(t,a){return e({method:"POST",data:a,url:`/${t}/insert`})}function n(e,n){var r=new Promise(function(r){var i;a(e,n).then(function(a){return i=a.data[0]._id,t.insert(e,n.Title)}).then(function(){r(i)})});return r}function r(t,a){return e.get(`/${t}/getByDate/${a}`)}function i(t,a){return e({method:"POST",url:`/${t}/find`,data:a})}function o(e){var t=new Promise(function(t){return i(e,{sort:{Date:-1},projection:{Title:1,Date:1,Text:1,Content:1}}).then(function(e){e.data.forEach(function(e){e.Date=new Date(e.Date),e.DateGroup=e.Date.toCompareString()}),t(e.data)})});return t}function s(t,a){var n=new Promise(function(n){var r,i={};e.get(`/${t}/findOne/${a}`).then(function(a){return i.item=a.data,r=new Date(i.item.Date).getTime(),e.get(`/${t}/getArticlesInTheSameDate/${r}`)}).then(function(n){i.sameDate=n.data[t].filter(function(e){return e._id!==a}),delete n.data[t],i.tweets=n.data.tweets.filter(function(e){return e.Type===f[t]}),i.tweets.forEach(function(e){e.Title.length>40&&(e.Title=e.Title.slice(0,40)+"...")}),delete n.data.tweets;var o=[];return _.forIn(n.data,function(e,t){_.each(e,function(e){o.push({_id:e._id,Title:e.Title,Type:t,Date:new Date(e.Date)})})}),i.articles=o,e.get(`/${t}/getPrevNearArticles/${r}`)}).then(function(a){return i.prevs=a.data,i.prevs.forEach(function(e){e.Date=new Date(e.Date)}),e.get(`/${t}/getNextNearArticles/${r}`)}).then(function(e){i.nexts=e.data,i.nexts.forEach(function(e){e.Date=new Date(e.Date)}),n(i)})});return n}function l(t,a){return e.get(`/${t}/delete/${a}`)}function c(e,a){var n=new Promise(function(n){l(e,a.id).then(function(){return t.remove(e,a.title)}).then(function(){n(a.id)})});return n}function d(t,a){return e.get(`/${t}/findOne/${a}`)}function u(t,a){return e({method:"POST",data:a,url:`/${t}/update`})}function p(e,a){var n=new Promise(function(n){u(e,a).then(function(){return t.update(e,a.Title)}).then(function(){n(a._id)})});return n}function g(t){return e.get(`/${t}/findAll`)}var f={agendas:"agenda",explications:"explication",treaties:"treaty",news:"new"};return{getByDate:r,insert:a,insertWithUserActions:n,find:i,getDetail:s,getList:o,remove:l,removeWithUserActions:c,findOne:d,update:u,updateWithUserActions:p,findAll:g}}),starApp.factory("accountService",function(e){var t=JSON.parse(localStorage.getItem("user"));return{authenticate:function(t,a){return e.post("/user/login",{username:t,password:a})},isAuthorized:function(e){return null!==t&&t.Role===e},setData:function(e){t=e.user,localStorage.setItem("user",JSON.stringify(t)),localStorage.setItem("token",e.token)},isLoggedIn:function(){return!!t},getUser:function(){return t},getUserName:function(){return t?t.UserName:""},getUserFullName:function(){return t?t.FullName:""},getId:function(){return t?t._id:null},logout:function(){localStorage.removeItem("user"),localStorage.removeItem("token"),t=null},isLogged:!1}}),starApp.factory("activityService",function(e){function t(){var t=new Promise(function(t){e.get("/summary").success(function(e){var a={};a.labels=_.pluck(e,"article"),a.data=_.pluck(e,"total"),t(a)})});return t}function a(){var t=new Promise(function(t){e.get(`/activities`).success(function(e){var a={};a.labels=_.pluck(e,"operation"),a.data=_.pluck(e,"total"),t(a)})});return t}function n(t){var a=new Promise(function(a){e.get(`/activities/${t}/250`).success(function(e){e.operations.forEach(function(e){e.date=new Date(e.date),e.title&&e.title.length>40&&(e.title=e.title.slice(0,40)+"...")}),a(e)})});return a}return{getSummary:t,getAllActivities:a,getActivities:n}}),starApp.factory("userActionService",function(e){function t(t,a,n){var r={operation:n,date:(new Date).getTime(),title:a,collection:t};return e.post("/userActions/insert",r)}function a(e,a){return t(e,a,"Add")}function n(e,a){return t(e,a,"Delete")}function r(e,a){return t(e,a,"Edit")}return{insert:a,remove:n,update:r}}),starApp.factory("verseService",function(e){function t(t){return e.post("/books/find",{TestamentId:t,sort:{DisplayOrder:1}})}function a(t){var a=new Promise(function(a){e.post("/verses/find",{BookId:t,sort:{Chapter:-1},limit:1}).success(function(e){var t=_.range(1,e[0].Chapter+1);a(t)})});return a}function n(t,a){var n=new Promise(function(n){e.post("/verses/find",{BookId:t,Chapter:a,sort:{Paragraph:-1},limit:1}).success(function(e){var t=_.range(1,e[0].Paragraph+1);n(t)})});return n}function r(t,a){return e.get("/verses/search/"+t+"/"+a)}function i(t,a,n,r,i){return e({method:"POST",url:"/verses/find",data:{BookId:t,Chapter:a,Paragraph:{gte:n,lte:r},Version:i,sort:{Paragraph:1}}})}return{getBooks:t,getChapters:a,getParagraphs:n,getVerses:i,search:r}}),starApp.factory("noteService",function(e){function t(t){return e.get("/notes/getNoteById/"+t)}function a(t){return e.get("/notes/getNotesByVerseId/"+t)}function n(t){var a="/notes/search";return t&&(a+="/"+t),e.get(a)}return{getNote:t,getNotes:a,search:n}}),starApp.factory("tweetService",function(e,t,a){function n(e){var t={Title:1,Date:1,Type:1},n=new Promise(function(n){return a.find(e,{sort:{Date:-1},projection:t}).then(function(e){e.data.forEach(function(e){e.Date=new Date(e.Date),e.DateGroup=e.Date.toCompareString()}),n(e.data)})});return n}return{getList:n}}),starApp.directive("header",function(e,t,a,n){return{scope:!0,templateUrl:"views/directives/core/header.html",restrict:"E",link:function(r){r[a.current.$$route.menuId]=!0,r.isLoggedIn=n.isLoggedIn(),r.fullName=n.getUserFullName(),r.logout=function(){n.logout(),r.isLoggedIn=!1,e.path("/login")},t.$on("account.loggedIn",function(e,t){r.fullName=t,r.isLoggedIn=!0})}}}),starApp.directive("notification",function(e,t,a,n){var r=io.connect(),i=n.getUserName();return{scope:!0,templateUrl:"views/directives/core/notification.html",restrict:"E",replace:!0,link:function(e){r.on("connect",function(){r.emit("join",i)}),r.on("initialization",function(a){e.page.users=a.users;var n;a.users.forEach(function(t){var r=t.nickname;e.page.messages[r]=[],a.messages.forEach(function(a){n=!0,a.seen||a.to!==i&&("broadcast"!==a.to||a.from===i)||(n=!1),"broadcast"===a.to&&"broadcast"===r?e.page.messages.broadcast.push({_id:a._id,author:a.from===i?"Me":a.from,message:a.message,date:new Date(a.date),displayDate:new Date(a.date).getElapsed(),seen:n}):a.from!==r&&a.to!==r||"broadcast"===a.to||e.page.messages[t.nickname].push({_id:a._id,author:a.from===r?r:"Me",message:a.message,date:new Date(a.date),displayDate:new Date(a.date).getElapsed(),seen:n})})}),e.page.nbOfNotifications=a.messages.filter(function(e){return n=!0,e.seen||e.to!==i&&("broadcast"!==e.to||e.from===i)||(n=!1),!n}).length,t.$emit("chat.users")}),r.on("message",function(a){e.page.nbOfNotifications++,"broadcast"===a.to?e.page.messages[a.to].push({author:a.from,message:a.message,date:new Date(a.date),displayDate:new Date(a.date).getElapsed()}):e.page.messages[a.from].push({author:a.from,message:a.message,date:new Date(a.date),displayDate:new Date(a.date).getElapsed()}),t.$emit("chat.messages")}),r.on("status",function(t){var a=e.page.users.filter(function(e){return e.nickname===t.nickname})[0];a.active=t.status}),t.$on("chat.send",function(e,t){r.emit("message",t)}),t.$on("chat.mark",function(e,t){var a={_id:t._id,seen:!0};r.emit("mark",a)})}}}),starApp.controller("pageController",function(e){e.page={},e.page.users=[],e.page.messages={},e.page.nbOfNotifications=0}),starApp.controller("loginController",function(e,t,a,n,r){t.page.title="Login",t.login=function(){var i=n.open({animation:!0,templateUrl:"message"});r.authenticate(t.user.UserName,t.user.Password).success(function(n){i.dismiss("cancel"),n?(r.setData(n),e.$emit("account.loggedIn",n.user.FullName),a.path("/")):t.error=!0}).error(function(){t.error=!0,i.dismiss("cancel")})}}),starApp.controller("readController",function(e){e.dataSearch=[],e.read={},e.search={},e.dtoNote=[]}),starApp.controller("tableReadController",function(e,t,a,n,r,i){e.dataRead=[];var o=a.get("lastRead"),s=!0;e.tableRead=i.create(e,"dataRead",!1,1e3),n.findAll("versions").success(function(t){e.read.versions=t,e.read.version=e.read.versions[0],s&&void 0!==o&&(e.read.version=e.read.versions[o.VersionIndex])}),n.findAll("testaments").success(function(t){e.read.testaments=t,e.read.testament=e.read.testaments[0],s&&void 0!==o&&(e.read.testament=e.read.testaments[o.TestamentIndex])}),e.$watch("read.testament",function(){e.read.testament&&r.getBooks(e.read.testament._id).success(function(t){e.read.books=t,e.read.book=e.read.books[0],e.read.chapter=1,s&&void 0!==o&&(e.read.book=e.read.books[o.BookIndex]),e.read.maxDisplayOrder=e.read.books[e.read.books.length-1].DisplayOrder})}),e.$watch("read.book",function(){e.read.book&&(r.getChapters(e.read.book._id).then(function(t){e.read.chapters=t,e.read.chapter=e.read.chapters[0],s&&void 0!==o&&(e.read.chapter=o.Chapter),e.read.maxChapter=e.read.chapters[e.read.chapters.length-1]}),angular.element(".glyphicon-fast-backward").css("opacity",1===e.read.book.DisplayOrder?"0.4":"1.0"),angular.element(".glyphicon-fast-forward").css("opacity",e.read.book.DisplayOrder===e.read.maxDisplayOrder?"0.4":"1.0"))}),e.$watch("read.chapter + read.book._id",function(){e.read.chapter&&(r.getParagraphs(e.read.book._id,parseInt(e.read.chapter)).then(function(t){e.read.paragraphs=t,e.read.paragraphMin=e.read.paragraphs[0],e.read.paragraphMax=e.read.paragraphs[e.read.paragraphs.length-1],s&&void 0!==o&&(e.read.paragraphMin=o.ParagraphMin,e.read.paragraphMax=o.ParagraphMax),e.$apply()}),angular.element(".glyphicon-chevron-left").css("opacity",1===e.read.chapter?"0.4":"1.0"),angular.element(".glyphicon-chevron-right").css("opacity",e.read.chapter===e.read.maxChapter?"0.4":"1.0"))}),e.$watch("read.paragraphMin + read.paragraphMax + read.version.Code",function(){e.search.textToSearch="",e.read.paragraphMin&&(e.page.title="Read",e.page.title+=" "+e.read.book.Description,e.page.title+=" "+e.read.chapter,a.put("lastRead",{TestamentIndex:e.read.testaments.map(function(e){return e._id}).indexOf(e.read.testament._id),BookIndex:e.read.book.DisplayOrder-1,Chapter:e.read.chapter,ParagraphMin:e.read.paragraphMin,ParagraphMax:e.read.paragraphMax,VersionIndex:e.read.versions.map(function(e){return e.Code}).indexOf(e.read.version.Code)}),r.getVerses(e.read.book._id,e.read.chapter,parseInt(e.read.paragraphMin),parseInt(e.read.paragraphMax),e.read.version.Code).success(function(t){e.dataRead=t,e.tableRead.reload(),s=!1}))}),e.prevChapter=function(){1!==e.read.chapter&&e.read.chapter--},e.nextChapter=function(){e.read.chapter!==e.read.maxChapter&&e.read.chapter++},e.prevBook=function(){1!==e.read.book.DisplayOrder&&(e.read.book=e.read.books[e.read.book.DisplayOrder-2])},e.nextBook=function(){e.read.book.DisplayOrder!==e.read.maxDisplayOrder&&(e.read.book=e.read.books[e.read.book.DisplayOrder])},e.changeVerseSelected=function(a){angular.forEach(e.dataRead,function(e){e.$selected=!1}),a.$selected=!0,e.read.selected=a,t.$emit("read.changeSelect",e.read.selected._id)}}),starApp.controller("tableSearchController",function(e,t,a,n){e.dataSearch=[],e.tableSearch=n.create(e,"dataSearch",!1,10),e.changeResultSelected=function(a){angular.forEach(e.dataSearch,function(e){e.$selected=!1}),a.$selected=!0,e.read.selected=a,t.$emit("read.changeSelect",a._id)};var r,i=200;e.search.searchContent=function(){clearTimeout(r),r=setTimeout(function(){!e.search.textToSearch||e.search.textToSearch.length<1||(e.page.title="Read",e.page.title+=" -  Searching for",e.page.title+=" "+e.search.textToSearch,a.search(e.read.version.Code,e.search.textToSearch).success(function(t){e.dataSearch=t,e.tableSearch.settings().total=t.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}))},i)}}),starApp.controller("tabController",function(e,t,a){t.$on("read.changeSelect",function(t,n){a.getNotes(n).success(function(t){e.dtoNote=t})})}),starApp.controller("agendaController",function(e,t,a,n,r,i){function o(){e.tableSearch.settings().total=e.datas.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}e.page.title="Agenda - Home page";var s=[];e.datas=[],e.activity={},e.activity.operations=[],e.tableSearch=i.create(e,"datas",!0),e.tableOperations=i.create(e,"activity.operations"),n.getList("agendas").then(function(a){s=a,e.datas=s,e.txtSearch=t.get("lastAgendaSearch"),e.search(),o()}),r.getActivities("agendas").then(function(t){e.activity=t,e.tableOperations.reload()}),e.goToDetail=function(e){a.path("/agendas/detail/"+e._id)},e.search=function(){if(t.put("lastAgendaSearch",e.txtSearch),e.txtSearch){var a=new RegExp(e.txtSearch,"i");e.datas=s.filter(function(e){return a.test(e.Title)||a.test(e.Text)})}else e.datas=s;o()}}),starApp.controller("detailAgendaController",function(e,t,a,n,r){e.page.title="Agenda - Detail - ",e.tableNexts=r.create(e,"nexts"),e.tablePrevs=r.create(e,"prevs"),e.tableSameDate=r.create(e,"sameDate"),e.tableTweets=r.create(e,"tweets"),e.tableOtherArticles=r.create(e,"articles"),n.getDetail("agendas",t.id).then(function(t){e.agenda=t.item,e.page.title+=e.agenda.Title,e.sameDate=t.sameDate,e.tweets=t.tweets,e.articles=t.articles,e.prevs=t.prevs,e.nexts=t.nexts,e.$apply()}),e.promptDelete=function(t){var r=confirm("Are you sure you want to delete this agenda?");if(r){var i={id:t._id,title:t.Title};n.removeWithUserActions("agendas",i).then(function(){a.path("/agendas"),e.$apply()})}}}),starApp.controller("addAgendaController",function(e,t,a,n){e.page.title="Agenda - Add",e.agenda={},e.Date=new Date,e.data=[],e.tableParams=n.create(e,"data"),e.changeDate=function(){a.getByDate("agendas",e.Date).success(function(t){e.data=t,e.tableParams.reload()})},e.changeDate(),e.save=function(){var n=e.agenda;n.Date=new Date(e.Date).getTime(),a.insertWithUserActions("agendas",n).then(function(a){t.path("/agendas/detail/"+a),e.$apply()})}}),starApp.controller("editAgendaController",function(e,t,a,n,r){e.page.title="Agenda - Edit - ",e.id=t.id,e.Date=new Date,e.agenda={},e.data=[],e.tableParams=r.create(e,"data"),n.findOne("agendas",e.id).then(function(t){e.agenda=t.data,e.page.title+=e.agenda.Title,e.Date=new Date(e.agenda.Date),e.changeDate(),e.tableParams.reload()}),e.changeDate=function(){n.getByDate("agendas",e.Date).success(function(t){e.data=t.filter(function(t){return t._id!==e.id}),e.tableParams.reload()})},e.save=function(){var t=e.agenda;t._id=e.id,t.Date=new Date(e.Date).getTime(),n.updateWithUserActions("agendas",t).then(function(t){a.path("/agendas/detail/"+t),e.$apply()})}}),starApp.controller("addNoteController",function(e,t,a,n){e.tags=[],n.find("tags",{Type:"Note"}).success(function(t){e.tags=t}),e.valid=function(){return e.tags.filter(function(e){return e.Selected===!0}).length>0},e.save=function(){var r={Description:e.Description,Content:e.Content,TagIdList:e.tags.filter(function(e){return e.Selected===!0}).map(function(e){return e._id}),VerseId:t.id};n.insert("notes",r).success(function(){a.path("/")}).error(function(e){console.log(e)})}}),starApp.controller("editNoteController",function(e,t,a,n,r){e.tags=[],n.getNote(t.id).success(function(t){e.note._id=t.Note._id,e.note.VerseId=t.Note.VerseId,e.note.Description=t.Note.Description,e.note.Content=t.Note.Content,e.tags=t.Tags,e.tags.forEach(function(e){e.Selected=e.IsActive})}),e.valid=function(){return e.tags.filter(function(e){return e.Selected===!0}).length>0},e.save=function(){var t={_id:e.note._id,Description:e.note.Description,Content:e.note.Content,TagIdList:e.tags.filter(function(e){return e.Selected===!0}).map(function(e){return e._id}),VerseId:e.note.VerseId};r.update("notes",t).success(function(){a.path("/")}).error(function(e){console.log(e)})}}),starApp.controller("listNoteController",function(e,t,a){e.page.title="Note - List",e.notes=[],e.tableNote=a.create(e,"notes"),e.search=function(){t.search(e.txtSearch).success(function(t){e.notes=t,e.tableNote.settings().total=e.notes.length,e.tableNote.parameters().page=1,e.tableNote.reload()})},e.search(),e.changeNoteSelected=function(a){e.notes.forEach(function(e){e.$selected=!1}),a.$selected=!a.$selected,e.page.title="Note - "+a.Verse,t.getNotes(a.VerseId).success(function(t){e.dtoNote=t})}}),starApp.controller("dicosController",function(e,t,a,n,r){var i=[];e.cultures=[],e.dico={},e.dicos=[],e.filter={},e.illustrations=[],e.page.title="Dico - Home page",e.tableDico=r.create(e,"dicos",!1,1e3),e.tableIllustration=r.create(e,"illustrations"),n.findAll("cultures").then(function(a){e.cultures=a.data,e.cultures.unshift({Description:"All",_id:-1});var r=0,i=0;return e.filter=t.get("dicosFilter")||{},_.isEmpty(e.filter)||(r=e.filter.From,i=e.filter.To),e.filter.To=e.cultures[i],e.filter.From=e.cultures[r],n.findAll("dicos")}).then(function(t){i=t.data,i.forEach(function(e){e.StrIllustrations=e.Illustrations?e.Illustrations.join("."):""}),e.dicos=t.data,e.search()}),e.changeLabelSelected=function(t){e.dicos.forEach(function(e){e.$selected=!1}),t.$selected=!t.$selected,e.dico=t,e.dico.From=_.findWhere(e.cultures,{_id:e.dico.FromId}).Description,e.dico.To=_.findWhere(e.cultures,{_id:e.dico.ToId}).Description,e.illustrations=e.dico.Illustrations,e.tableIllustration.reload()},e.remove=function(t){var a=confirm("Are you sure you want to delete this dico?");a&&n.remove("dicos",t).success(function(){e.dicos=e.dicos.filter(function(e){return e._id!==t}),e.tableDico.reload(),e.changeLabelSelected(e.dicos[0])})},e.search=function(){t.put("dicosFilter",{Text:e.filter.Text,From:_.findIndex(e.cultures,{_id:e.filter.From._id}),To:_.findIndex(e.cultures,{_id:e.filter.To._id})}),e.dicos=_.filter(i,function(t){return(-1===e.filter.To._id||e.filter.To._id===t.ToId)&&(-1===e.filter.From._id||e.filter.From._id===t.FromId)&&(!e.filter.Text||e.filter.Text===t.Text.substring(0,e.filter.Text.length)||!e.filter.Text||e.includeMeaning&&t.Meaning.includes(e.filter.Text))||!e.filter.Text||e.includeIllustration&&t.StrIllustrations.includes(e.filter.Text)}),o()};var o=function(){e.dicos=_.sortBy(e.dicos,"Text"),e.tableDico.reload(),e.dicos.length>0&&(e.dico=e.dicos[0],e.changeLabelSelected(e.dico))}}),starApp.controller("addDicoController",function(e,t,a,n,r){e.page.title="Dico - ",e.cultures=[],e.dico={},e.dico.Meaning="",e.illustrations=[],e.culturesId=[];var i=t.id;n.findAll("cultures").then(function(t){return e.cultures=t.data,e.dico.To=e.cultures[2],e.dico.From=e.cultures[1],e.culturesId=_.pluck(e.cultures,"_id"),i?n.findOne("dicos",i).then(function(t){e.dico=t.data,e.page.title+="Edit - "+e.dico.Text,e.dico.To=e.cultures[e.culturesId.indexOf(e.dico.ToId)],e.dico.From=e.cultures[e.culturesId.indexOf(e.dico.FromId)],e.illustrations=e.dico.Illustrations.map(function(e){return{Text:e}}),e.tableIllustration.reload()}):(e.page.title+="Add",Promise.resolve(null))}).then(function(t){if(t){e.dico=t.data,e.page.title+="Edit - "+e.dico.Text;var a=_.pluck(e.cultures,"_id");e.dico.To=e.cultures[a.indexOf(e.dico.ToId)],e.dico.From=e.cultures[a.indexOf(e.dico.FromId)],e.illustrations=e.dico.Illustrations.map(function(e){return{Text:e}}),e.tableIllustration.reload()}}),e.tableIllustration=r.create(e,"illustrations"),e.addIllustration=function(){e.illustrations.push({Text:e.newIllustration.Text}),e.tableIllustration.reload(),e.newIllustration.Text="",e.newIllustration.$edit=!1},e.cancelAddIllustration=function(){e.newIllustration.Text="",e.newIllustration.$edit=!1},e.removeIllustration=function(t){e.illustrations=e.illustrations.filter(function(e){return e.Text!==t.Text}),e.tableIllustration.reload()},e.editIllustration=function(e){e.editIllustration.$edit=!1},e.cancelEditIllustration=function(e){e.Text=o,e.editIllustration.$edit=!1};var o="";e.startEditIllustration=function(e){o=e.Text},e.loadInfo=function(){e.dico.Text&&e.culturesId.length&&n.find("dicos",{Text:e.dico.Text}).success(function(t){t.length&&(console.log(t),e.otherMeanings=t,e.otherMeanings.forEach(function(t){t.To=e.cultures[e.culturesId.indexOf(t.ToId)],t.From=e.cultures[e.culturesId.indexOf(t.FromId)]}))})},e.save=function(){var t=JSON.parse(JSON.stringify(e.dico));t.FromId=t.From._id,t.ToId=t.To._id,delete t.From,delete t.To;var r;r=void 0===i?"insert":"update",t.Illustrations=e.illustrations.map(function(e){return e.Text});var o=n[r].call({},"dicos",t);o.then(function(){a.path("dicos")})}}),starApp.controller("treatyController",function(e,t,a,n,r,i,o,s,l){function c(){e.tableSearch.settings().total=e.datas.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}e.page.title="Treaty - Home page";var d=[];e.datas=[],e.activity={},e.activity.operations=[],e.tableSearch=o.create(e,"datas",!0),e.tableOperations=o.create(e,"activity.operations"),l.getList("treaties").then(function(a){d=a,e.datas=d,e.txtSearch=t.get("lastTreatySearch"),e.search(),c()}),s.getActivities("treaties").then(function(t){e.activity=t,e.tableOperations.reload()}),e.goToDetail=function(e){i.path("/treaties/detail/"+e._id)},e.search=function(){if(t.put("lastTreatySearch",e.txtSearch),e.txtSearch){var a=new RegExp(e.txtSearch,"i");e.datas=d.filter(function(e){return a.test(e.Title)||a.test(e.Text)})}else e.datas=d;c()}}),starApp.controller("addTreatyController",function(e,t,a,n,r){e.page.title="Treaty - ";var i=t.id;e.data=[],e.treaty={},e.tags=[],e.tableParams=n.create(e,"data"),r.find("tags",{Type:"Treaty"}).then(function(t){e.tags=t.data}).then(function(){void 0===i?(e.page.title+="Add",e.Date=new Date,e.changeDate()):r.findOne("treaties",i).success(function(t){e.treaty=t,e.page.title+="Edit "+e.treaty.Title;for(var a=e.tags.length-1;a>=0;a--)for(var n=e.treaty.TagIdList.length-1;n>=0;n--)e.tags[a]._id===e.treaty.TagIdList[n]&&(e.tags[a].IsSelected=!0,e.tags[a].Selected=!0);e.Date=new Date(t.Date),e.changeDate()})}),e.changeDate=function(){r.getByDate("treaties",e.Date).success(function(t){e.data=t,void 0!==i&&(e.data=e.data.filter(function(e){return e._id!==i})),e.tableParams.reload()})},e.valid=function(){return e.tags.filter(function(e){return e.Selected===!0}).length>0},e.cancel=function(){i?a.path("/treaties/detail/"+i):a.path("/treaties")},e.save=function(){var t=JSON.parse(JSON.stringify(e.treaty));t.Date=new Date(e.Date).getTime(),t.TagIdList=e.tags.filter(function(e){return e.Selected===!0}).map(function(e){return e._id});var n;void 0!==i?(t._id=i,n="updateWithUserActions"):n="insertWithUserActions";var o=r[n].call({},"treaties",t);o.then(function(t){void 0!==i?a.path("/treaties/detail/"+i):a.path("treaties/detail/"+t),e.$apply()})}}),starApp.controller("detailTreatyController",function(e,t,a,n,r){e.page.title="Treaty - Detail - ";var i=a.id;e.sameDate=[],e.articles=[],e.prevs=[],e.nexts=[],e.tableNexts=n.create(e,"nexts"),e.tablePrevs=n.create(e,"prevs"),e.tableSameDate=n.create(e,"sameDate"),e.tableTweets=n.create(e,"tweets"),e.tableOtherArticles=n.create(e,"articles"),r.getDetail("treaties",i).then(function(t){return e.treaty=t.item,e.page.title+=e.treaty.Title,e.sameDate=t.sameDate,e.tweets=t.tweets,e.articles=t.articles,e.prevs=t.prevs,e.nexts=t.nexts,r.find("tags",{Type:"Treaty"})}).then(function(t){e.treaty.TagIdList.forEach(function(e,a,n){n[a]=_.findWhere(t.data,{_id:e}).Description}),e.$apply()}),e.promptDelete=function(a){var n=confirm("Are you sure you want to delete this treaty?");if(n){var i={id:a._id,title:a.Title};r.removeWithUserActions("treaties",i).then(function(){t.path("/treaties"),e.$apply()})}}}),starApp.controller("explicationController",function(e,t,a,n,r,i,o){function s(){e.tableSearch.settings().total=e.datas.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}e.page.title="Explication - Home page";var l=[];e.datas=[],e.activity={},e.activity.operations=[],e.tableSearch=i.create(e,"datas",!0),e.tableOperations=i.create(e,"activity.operations"),r.getList("explications").then(function(a){l=a,e.datas=l,e.txtSearch=t.get("lastExplicationSearch"),e.search(),s()}),o.getActivities("explications").then(function(t){e.activity=t,e.tableOperations.reload()}),e.goToDetail=function(e){n.path("/explications/detail/"+e._id)},e.search=function(){if(t.put("lastExplicationSearch",e.txtSearch),e.txtSearch){var a=new RegExp(e.txtSearch,"i");e.datas=l.filter(function(e){return a.test(e.Title)||a.test(e.Content)})}else e.datas=l;s()}}),starApp.controller("addExplicationController",function(e,t,a,n,r){e.page.title="Explication - ";var i=t.id;e.read={},e.read.verses=[],e.data=[],e.tags=[],e.explication={},e.tableParams=r.create(e,"data"),e.tableVerses=r.create(e,"read.verses"),n.find("tags",{Type:"Explication"}).then(function(t){e.tags=t.data,void 0===i?(e.page.title+="Add",e.explication.Date=new Date,e.changeDate()):n.findOne("explications",i).success(function(t){e.explication=t,e.page.title+="Edit - "+e.explication.Title;for(var a=e.tags.length-1;a>=0;a--)for(var n=e.explication.TagIdList.length-1;n>=0;n--)e.tags[a]._id===e.explication.TagIdList[n]&&(e.tags[a].IsSelected=!0,e.tags[a].Selected=!0);e.read.verses=e.explication.VerseReadList,
e.explication.Date=new Date(t.Date),e.changeDate(),e.tableVerses.reload()})}),e.changeDate=function(){n.getByDate("explications",e.explication.Date).success(function(t){e.data=t,void 0!==i&&(e.data=_.reject(e.data,{_id:i})),e.tableParams.reload()})},e.valid=function(){return e.tags.filter(function(e){return e.Selected===!0}).length>0&&e.read.verses.length>0},e.cancel=function(){i?a.path("/explications/detail/"+i):a.path("/explications")},e.save=function(){var t=JSON.parse(JSON.stringify(e.explication));t.Date=new Date(e.explication.Date).getTime(),t.TagIdList=_.pluck(_.where(e.tags,{Selected:!0}),"_id"),t.VerseReadList=e.read.verses;var r;void 0!==i?(t._id=i,r="updateWithUserActions"):r="insertWithUserActions";var o=n[r].call({},"explications",t);o.then(function(t){void 0!==i?a.path("/explications/detail/"+i):a.path("explications/detail/"+t),e.$apply()})}}),starApp.controller("detailExplicationController",function(e,t,a,n,r){e.page.title="Explication - Detail - ",e.explication={},e.explication.VerseReadList=[],e.sameDate=[],e.articles=[],e.prevs=[],e.nexts=[],e.tableNexts=r.create(e,"nexts"),e.tablePrevs=r.create(e,"prevs"),e.tableSameDate=r.create(e,"sameDate"),e.tableOtherArticles=r.create(e,"articles"),e.tableTweets=r.create(e,"tweets"),e.tableVerses=r.create(e,"explication.VerseReadList"),n.getDetail("explications",t.id).then(function(t){return e.explication=t.item,e.page.title+=e.explication.Title,e.sameDate=t.sameDate,e.tweets=t.tweets,e.articles=t.articles,e.prevs=t.prevs,e.nexts=t.nexts,e.tableVerses.reload(),n.find("tags",{Type:"Explication"})}).then(function(t){e.explication.TagIdList.forEach(function(e,a,n){n[a]=_.findWhere(t.data,{_id:e}).Description}),e.$apply()}),e.promptDelete=function(t){var r=confirm("Are you sure you want to delete this explication?");if(r){var i={id:t._id,title:t.Title};n.removeWithUserActions("explications",i).then(function(){a.path("/explications"),e.$apply()})}}}),starApp.controller("verseController",function(e,t,a){t.findAll("versions").success(function(t){e.read.versions=t,e.read.version=e.read.versions[0]}),t.findAll("testaments").success(function(t){e.read.testaments=t,e.read.testament=e.read.testaments[0]}),e.$watch("read.testament",function(){e.read.testament&&a.getBooks(e.read.testament._id).success(function(t){e.read.books=t,e.read.book=e.read.books[0],e.read.maxDisplayOrder=e.read.books[e.read.books.length-1].DisplayOrder})}),e.$watch("read.book",function(){e.read.book&&a.getChapters(e.read.book._id).then(function(t){e.read.chapters=t,e.read.chapter=e.read.chapters[0],e.read.maxChapter=e.read.chapters[e.read.chapters.length-1],e.$apply()})}),e.$watch("read.chapter + read.book.Id",function(){e.read.chapter&&a.getParagraphs(e.read.book._id,parseInt(e.read.chapter)).then(function(t){e.read.paragraphs=t,e.read.paragraphMin=e.read.paragraphs[0],e.read.paragraphMax=e.read.paragraphs[e.read.paragraphs.length-1],e.$apply()})}),e.read.addVerse=function(){var t={Book:e.read.book.Description,Chapter:e.read.chapter,ParagraphMin:e.read.paragraphMin,ParagraphMax:e.read.paragraphMax};e.read.verses.push(t),e.tableVerses.reload()},e.read.removeVerseRead=function(t){e.read.verses=e.read.verses.filter(function(e){return t.Book!==e.Book||t.Chapter!==e.Chapter||t.ParagraphMin!==e.ParagraphMin||t.ParagraphMax!==e.ParagraphMax}),e.tableVerses.reload()}}),starApp.controller("detailNewController",function(e,t,a,n,r){e.page.title="New - Detail - ";var i=t.id;e["new"]={},e["new"].citations=[],e.sameDate=[],e.articles=[],e.prevs=[],e.nexts=[],e.tableNexts=r.create(e,"nexts"),e.tablePrevs=r.create(e,"prevs"),e.tableSameDate=r.create(e,"sameDate"),e.tableOtherArticles=r.create(e,"articles"),e.tableTweets=r.create(e,"tweets"),e.tableCitations=r.create(e,"new.citations"),n.getDetail("news",i).then(function(t){e["new"]=t.item,e.page.title+=e["new"].Title,e.sameDate=t.sameDate,e.tweets=t.tweets,e.articles=t.articles,e.prevs=t.prevs,e.nexts=t.nexts,e.tableCitations.reload(),e.$apply()}),e.promptDelete=function(t){var r=confirm("Are you sure you want to delete this new?");if(r){var i={id:t._id,title:t.Title};n.removeWithUserActions("news",i).then(function(){a.path("/news"),e.$apply()})}}}),starApp.controller("newController",function(e,t,a,n,r,i,o,s,l){function c(){e.tableSearch.settings().total=e.datas.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}e.page.title="New - Home page";var d=[];e.datas=[],e.activity={},e.activity.operations=[],e.tableSearch=s.create(e,"datas",!0),e.tableOperations=s.create(e,"activity.operations"),l.getList("news").then(function(t){d=t,e.datas=d,e.txtSearch=r.get("lastNewSearch"),e.search(),c()}),o.getActivities("news").then(function(t){e.activity=t,e.tableOperations.reload()}),e.goToDetail=function(e){i.path("/news/detail/"+e._id)},e.search=function(){if(r.put("lastNewSearch",e.txtSearch),e.txtSearch){var t=new RegExp(e.txtSearch,"i");e.datas=d.filter(function(e){return t.test(e.Title)||t.test(e.Content)})}else e.datas=d;c()}}),starApp.controller("addNewController",function(e,t,a,n,r){e.page.title="New - ";var i=t.id;e.news=[],e["new"]={},e["new"].citations=[],e.sources=[],e.tableNews=n.create(e,"news"),e.tableCitations=n.create(e,"new.citations"),r.findAll("sources").then(function(t){e.sources=t.data}).then(function(){void 0===i?(e.page.title+="Add",e["new"].Date=new Date,e.changeDate()):r.findOne("news",i).success(function(t){e["new"]=t,e.page.title+="Edit - "+e["new"].Title,e["new"].Date=new Date(t.Date).toISOString().split("T")[0],e.tableCitations.reload();var a=_.pluck(e.sources,"_id");e["new"].Source=e.sources[a.indexOf(e["new"].Source._id)],e["new"].Date=new Date(t.Date),e.changeDate()})}),e.changeDate=function(){void 0!==e["new"].Date&&""!==e["new"].Date&&r.getByDate("news",e["new"].Date).success(function(t){e.news=t,void 0!==i&&(e.news=_.reject(e.news,{_id:i})),e.tableNews.reload()})},e.valid=function(){return e["new"].citations.length>0&&e["new"].Content.length>0&&void 0!==e["new"].Source},e.addCitation=function(){e["new"].citations.push({text:e.text,author:e.author}),e.tableCitations.reload(),e.text="",e.author=""},e.removeCitation=function(t){e["new"].citations=_.without(e["new"].citations,t),e.tableCitations.reload()},e.cancel=function(){i?a.path("/news/detail/"+i):a.path("/news")},e.save=function(){var t=JSON.parse(JSON.stringify(e["new"]));t.Date=new Date(e["new"].Date).getTime();var n;void 0!==i?(t._id=i,n="updateWithUserActions"):n="insertWithUserActions";var o=r[n].call({},"news",t);o.then(function(t){void 0!==i?a.path("/news/detail/"+i):a.path("news/detail/"+t),e.$apply()})}}),starApp.controller("activityController",function(e,t,a){e.page.title="Activity",t.getSummary().then(function(t){e.generalLabels=t.labels,e.generalData=t.data}),t.getAllActivities().then(function(t){e.operationsLabels=t.labels,e.operationsData=t.data}),e.agendaActivity={},e.agendaActivity.operations=[],e.tableAgendaOperations=a.create(e,"agendaActivity.operations"),t.getActivities("agendas").then(function(t){e.agendaActivity=t,e.tableAgendaOperations.settings().total=e.agendaActivity.operations.length,e.tableAgendaOperations.parameters().page=1,e.tableAgendaOperations.reload()}),e.explicationActivity={},e.explicationActivity.operations=[],e.tableExplicationOperations=a.create(e,"explicationActivity.operations"),t.getActivities("explications").then(function(t){e.explicationActivity=t,e.tableExplicationOperations.settings().total=e.explicationActivity.operations.length,e.tableExplicationOperations.parameters().page=1,e.tableExplicationOperations.reload()}),e.treatyActivity={},e.treatyActivity.operations=[],e.tableTreatyOperations=a.create(e,"treatyActivity.operations"),t.getActivities("treaties").then(function(t){e.treatyActivity=t,e.tableTreatyOperations.settings().total=e.treatyActivity.operations.length,e.tableTreatyOperations.parameters().page=1,e.tableTreatyOperations.reload()}),e.newActivity={},e.newActivity.operations=[],e.tableNewOperations=a.create(e,"newActivity.operations"),t.getActivities("news").then(function(t){e.newActivity=t,e.tableNewOperations.settings().total=e.newActivity.operations.length,e.tableNewOperations.parameters().page=1,e.tableNewOperations.reload()}),e.tweetActivity={},e.tweetActivity.operations=[],e.tableTweetOperations=a.create(e,"tweetActivity.operations"),t.getActivities("tweets").then(function(t){e.tweetActivity=t,e.tableTweetOperations.settings().total=e.tweetActivity.operations.length,e.tableTweetOperations.parameters().page=1,e.tableTweetOperations.reload()})}),starApp.controller("error500Controller",function(e){e.page.title="Error 500"}),starApp.controller("tweetController",function(e,t,a,n,r,i,o){function s(){e.tableSearch.settings().total=e.datas.length,e.tableSearch.parameters().page=1,e.tableSearch.reload()}e.page.title="Tweet - Home page";var l=[];e.datas=[],e.activity={},e.activity.operations=[],e.tableSearch=o.create(e,"datas",!0),e.tableOperations=o.create(e,"activity.operations"),r.getList("tweets","Type").then(function(a){l=a,e.datas=l,e.txtSearch=t.get("lastTweetSearch"),e.search(),s()}),i.getActivities("tweets").then(function(t){e.activity=t,e.tableOperations.reload()}),e.edit=function(e){a.path("/tweets/edit/"+e._id)},e.search=function(){if(t.put("lastTweetSearch",e.txtSearch),e.txtSearch){var a=new RegExp(e.txtSearch,"i");e.datas=l.filter(function(e){return a.test(e.Title)})}else e.datas=l;s()}}),starApp.controller("addTweetController",function(e,t,a,n,r,i,o){e.page.title="Tweet - ",e.datas=[],e.activity={},e.activity.operations=[],e.model={},e.model.Date=new Date,e.contentTypes=[];var s=t.id;e.tableSearch=o.create(e,"datas",!0),e.tableOperations=o.create(e,"activity.operations"),n.findAll("contentTypes").success(function(t){e.contentTypes=_.pluck(t,"name"),e.model.Type=e.contentTypes[0]}),s?n.findOne("tweets",s).success(function(t){e.model=t,e.page.title+="Edit - "+e.model.Title,e.model.Date=new Date(t.Date)}):e.page.title+="Add",i.getActivities("tweets").then(function(t){e.activity=t,e.tableOperations.reload()}),e.save=function(){var t=JSON.parse(JSON.stringify(e.model));t.Date=e.model.Date.getTime();var r;s?(t._id=s,r="updateWithUserActions"):r="insertWithUserActions";var i=n[r].call({},"tweets",t);i.then(function(){a.path("/tweets"),e.$apply()})}}),starApp.controller("chatController",function(e,t,a,n){t.page.title="Chat",t.userName=n.getUserName(),t.selectedMessages=[],t.tableUser=a.create(t,"page.users",!1,100),t.tableMessage=a.create(t,"selectedMessages",!1,100),t.changeUserSelected=function(e){t.page.users.forEach(function(e){e.$selected=!1}),e.$selected=!0,t.user=e,t.selectedMessages=t.page.messages[e.nickname],t.tableMessage.reload()},e.$on("chat.users",function(){t.tableUser.reload()}),e.$on("chat.messages",function(){t.tableMessage.reload()}),t.sendMessage=function(){var a={from:t.userName,message:t.message,to:t.user.nickname,date:new Date};e.$emit("chat.send",a),t.page.messages[a.to].push({author:"Me",message:a.message,date:a.date,seen:!0}),t.tableMessage.reload(),t.message=""},t.markSeen=function(a){a.seen||(t.page.nbOfNotifications--,a.seen=!0,e.$emit("chat.mark",a))},setInterval(function(){_.forIn(t.page.messages,function(e){e.forEach(function(e){e.displayDate=e.date.getElapsed()})}),t.tableMessage.reload()},1e4)});